<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

  <mapper namespace="kr.tracom.mapper.ST0805.ST0805Mapper">
  
   <select id="ST0805G0R0" resultType="Map">
		SELECT  ROUT_ID
				,ROUT_GRP
				,ROUT_GRP_NM
				,ROUT_NM
				,ROUT_LEN
		FROM 
			BMS_ROUT_MST
		WHERE 
			DEL_YN != 'Y'
			<if test="CONTENT != NULL">
				AND ROUT_GRP LIKE CONCAT('%',#{CONTENT},'%') 
			</if>
		ORDER BY ROUT_GRP_NM
	</select>
	
	<select id="ST0805G1R0" resultType="Map" parameterType="Map">
		SELECT  
			A.OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,B.NODE_NM AS STTN_NM
		FROM 
			BMS_STTN_PNCTLTY_STAT A
			LEFT JOIN BMS_ROUT_NODE_CMPSTN B
			ON A.NODE_ID = B.NODE_ID
		WHERE 
			A.ROUT_ID = #{ROUT_ID} AND B.NODE_TYPE = 'NT002'
		GROUP BY
			A.NODE_ID
		ORDER BY 
			B.NODE_SN
	</select>
  
  <select id="ST0805G2R0" resultType="Map">
  		SELECT
  		<if test="SELECT_DIV == 'TIME'">
 				DATE_FORMAT(A.OPER_DT, '%Y-%m-%d') OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,B.STTN_NM
			,CONCAT(A.STAT_H, '시') AS STAT_H
			,DELAY_TIME
		</if>
		<if test="SELECT_DIV == 'WEEK'">
 				DATE_FORMAT(DATE(A.OPER_DT), '%Y-%m-%d') OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,A.DAY_WEEK
			,B.STTN_NM
			,CONCAT(A.STAT_H, '시') AS STAT_H
			,SUM(DELAY_TIME) AS DELAY_TIME
		</if>
		<if test="SELECT_DIV == 'MONTH'">
 				MONTH(A.OPER_DT) AS OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,B.STTN_NM
			,CONCAT(A.STAT_H, '시') AS STAT_H
			,SUM(DELAY_TIME) AS DELAY_TIME
		</if>
		FROM
			BMS_STTN_PNCTLTY_STAT A
			LEFT JOIN BMS_STTN_MST B
			ON A.NODE_ID = B.STTN_ID
		WHERE
			A.ROUT_ID = #{ROUT_ID}
			AND A.NODE_ID IN
		<foreach collection="NODE_ID" item="item" index="index"  open="(" close=")" separator=",">
			#{item}
		</foreach>
		<if test="F_DATE != null and F_DATE != '' and L_DATE != null and L_DATE != '' ">
			AND DATE_FORMAT(A.OPER_DT, '%Y-%m-%d') BETWEEN #{F_DATE} AND #{L_DATE}
		</if>
		<if test="SELECT_DIV == 'TIME'">
			<if test="ST_STAT_H != null and ST_STAT_H != '' and ED_STAT_H != null and ED_STAT_H != '' ">
				AND A.STAT_H BETWEEN #{ST_STAT_H} AND #{ED_STAT_H}
			</if>
		</if>
		<if test="SELECT_DIV == 'TIME'">
		GROUP BY
			NODE_ID, A.STAT_H
		ORDER BY
			NODE_ID, A.STAT_H
		</if>
		<if test="SELECT_DIV == 'WEEK'">
		GROUP BY
			DAY_WEEK, A.NODE_ID
		ORDER BY
			A.NODE_ID, DAY_WEEK
		</if>
		<if test="SELECT_DIV == 'MONTH'">
		GROUP BY 
			A.NODE_ID
		ORDER BY
			A.NODE_ID, A.OPER_DT 
		</if>
  </select>
  
  <select id="ST0805G1R1" resultType="Map">
  		SELECT
  		<if test="SELECT_DIV == 'TIME'">
 				DATE_FORMAT(A.OPER_DT, '%Y-%m-%d') OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,B.STTN_NM
			,CONCAT(A.STAT_H, '시') AS STAT_H
			,A.DELAY_TIME
		</if>
		<if test="SELECT_DIV == 'WEEK'">
 				DATE_FORMAT(DATE(A.OPER_DT), '%Y-%m-%d') OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,A.DAY_WEEK
			,B.STTN_NM
			,CONCAT(A.STAT_H, '시') AS STAT_H
			,SUM(DELAY_TIME) AS DELAY_TIME
		</if>
		<if test="SELECT_DIV == 'MONTH'">
 				MONTH(A.OPER_DT) AS OPER_DT
			,A.ROUT_GRP
			,A.ROUT_ID
			,A.NODE_ID
			,B.STTN_NM
			,CONCAT(A.STAT_H, '시') AS STAT_H
			,A.DELAY_TIME
		</if>
		FROM
			BMS_STTN_PNCTLTY_STAT A
			LEFT JOIN BMS_STTN_MST B
			ON A.NODE_ID = B.STTN_ID
		WHERE
			A.ROUT_ID = #{ROUT_ID}
			AND A.NODE_ID IN
		<foreach collection="NODE_ID" item="item" index="index"  open="(" close=")" separator=",">
			#{item}
		</foreach>
		<if test="F_DATE != null and F_DATE != '' and L_DATE != null and L_DATE != '' ">
			AND DATE_FORMAT(A.OPER_DT, '%Y-%m-%d') BETWEEN #{F_DATE} AND #{L_DATE}
		</if>
		<if test="SELECT_DIV == 'TIME'">
			<if test="ST_STAT_H != null and ST_STAT_H != '' and ED_STAT_H != null and ED_STAT_H != '' ">
				AND A.STAT_H BETWEEN #{ST_STAT_H} AND #{ED_STAT_H}
			</if>
		</if>
		<if test="SELECT_DIV == 'TIME'">
		GROUP BY
			NODE_ID, A.STAT_H
		ORDER BY
			NODE_ID, A.STAT_H
		</if>
		<if test="SELECT_DIV == 'WEEK'">
		GROUP BY
			DAY_WEEK, A.NODE_ID
		ORDER BY
			A.NODE_ID, DAY_WEEK
		</if>
		<if test="SELECT_DIV == 'MONTH'">
		GROUP BY 
			A.NODE_ID
		ORDER BY
			A.NODE_ID, A.OPER_DT 
		</if>
  </select>
  
  <select id="selectStatHItem" parameterType="Map" resultType="Map">
	SELECT
		STAT_H 
		,CONCAT(STAT_H, '시') AS STAT_H_LABEL

	FROM 
		BMS_STTN_PNCTLTY_STAT
		
	ORDER BY
	 	STAT_H
</select>

</mapper>